<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Job Application Tracker</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #4CAF50;
            margin-bottom: 10px;
        }
        .nav-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #4CAF50;
            text-decoration: none;
            font-weight: bold;
        }
        .nav-link:hover {
            text-decoration: underline;
        }
        .status-message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            display: none;
        }
        .status-message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status-message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th {
            background-color: #4CAF50;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        td {
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }
        tr:hover {
            background-color: #f5f5f5;
        }
        .editable {
            cursor: pointer;
            padding: 5px;
            border: 1px solid transparent;
            border-radius: 3px;
            min-height: 20px;
            display: block;
            width: 100%;
        }
        .editable:hover {
            background-color: #f0f0f0;
            border-color: #4CAF50;
        }
        .editable:focus {
            outline: none;
            border-color: #4CAF50;
            background-color: white;
        }
        input.editable, select.editable, textarea.editable {
            width: 100%;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 14px;
            font-family: Arial, sans-serif;
        }
        textarea.editable {
            min-height: 60px;
            resize: vertical;
        }
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            display: inline-block;
        }
        .status-applied {
            background-color: #c7f3ff;
            color: #0066cc;
        }
        .status-interview {
            background-color: #c7ffc7;
            color: #006600;
        }
        .status-rejected {
            background-color: #ffc7c7;
            color: #cc0000;
        }
        .status-offer {
            background-color: #fff4c7;
            color: #cc9900;
        }
        .delete-btn {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        .delete-btn:hover {
            background-color: #da190b;
        }
        .link-cell a {
            color: #4CAF50;
            text-decoration: none;
        }
        .link-cell a:hover {
            text-decoration: underline;
        }
        .saving-indicator {
            display: inline-block;
            margin-left: 5px;
            color: #4CAF50;
            font-size: 12px;
        }
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        .empty-state h2 {
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="/" class="nav-link">← Back to Jobs List</a>
        <h1>Job Application Tracker</h1>
        
        <div id="status-message" class="status-message"></div>
        
        <div id="applications-table-container">
            <table id="applications-table">
                <thead>
                    <tr>
                        <th>Company Name</th>
                        <th>Application Status</th>
                        <th>Role</th>
                        <th>Salary</th>
                        <th>Date Submitted</th>
                        <th>Link to Job Req</th>
                        <th>Rejection Reason</th>
                        <th>Notes</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="applications-tbody">
                    <tr>
                        <td colspan="9" class="empty-state">
                            <h2>No applications yet</h2>
                            <p>Click "Applied" on a job in the jobs list to start tracking applications</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let applications = [];
        let saveTimeouts = {};

        // Load applications on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadApplications();
        });

        function loadApplications() {
            fetch('/api/applications')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        showMessage('Error loading applications: ' + data.error, 'error');
                    } else {
                        applications = data;
                        renderTable();
                    }
                })
                .catch(error => {
                    showMessage('Error loading applications: ' + error, 'error');
                });
        }

        function renderTable() {
            const tbody = document.getElementById('applications-tbody');
            
            if (applications.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="empty-state">
                            <h2>No applications yet</h2>
                            <p>Click "Applied" on a job in the jobs list to start tracking applications</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = applications.map(app => `
                <tr data-app-id="${app.id}">
                    <td>
                        <input type="text" class="editable" value="${escapeHtml(app.company_name || '')}" 
                               data-field="company_name" data-app-id="${app.id}">
                    </td>
                    <td>
                        <select class="editable" data-field="application_status" data-app-id="${app.id}">
                            <option value="Applied" ${app.application_status === 'Applied' ? 'selected' : ''}>Applied</option>
                            <option value="Interview" ${app.application_status === 'Interview' ? 'selected' : ''}>Interview</option>
                            <option value="Rejected" ${app.application_status === 'Rejected' ? 'selected' : ''}>Rejected</option>
                            <option value="Offer" ${app.application_status === 'Offer' ? 'selected' : ''}>Offer</option>
                            <option value="Withdrawn" ${app.application_status === 'Withdrawn' ? 'selected' : ''}>Withdrawn</option>
                        </select>
                    </td>
                    <td>
                        <input type="text" class="editable" value="${escapeHtml(app.role || '')}" 
                               data-field="role" data-app-id="${app.id}">
                    </td>
                    <td>
                        <input type="text" class="editable" value="${escapeHtml(app.salary || '')}" 
                               data-field="salary" data-app-id="${app.id}" placeholder="e.g., $80,000 - $100,000">
                    </td>
                    <td>
                        <input type="date" class="editable" value="${app.date_submitted || ''}" 
                               data-field="date_submitted" data-app-id="${app.id}">
                    </td>
                    <td class="link-cell">
                        <div style="display: flex; flex-direction: column; gap: 5px;">
                            <input type="url" class="editable" value="${escapeHtml(app.link_to_job_req || '')}" 
                                   data-field="link_to_job_req" data-app-id="${app.id}" 
                                   placeholder="https://...">
                            ${app.link_to_job_req ? 
                                `<a href="${escapeHtml(app.link_to_job_req)}" target="_blank" style="font-size: 12px;">Open Link →</a>` : 
                                ''
                            }
                        </div>
                    </td>
                    <td>
                        <textarea class="editable" data-field="rejection_reason" data-app-id="${app.id}" 
                                  placeholder="Reason for rejection...">${escapeHtml(app.rejection_reason || '')}</textarea>
                    </td>
                    <td>
                        <textarea class="editable" data-field="notes" data-app-id="${app.id}" 
                                  placeholder="Add notes...">${escapeHtml(app.notes || '')}</textarea>
                    </td>
                    <td>
                        <button class="delete-btn" onclick="deleteApplication(${app.id})">Delete</button>
                    </td>
                </tr>
            `).join('');

            // Add event listeners for auto-save
            tbody.querySelectorAll('.editable').forEach(element => {
                element.addEventListener('input', handleFieldChange);
                element.addEventListener('change', handleFieldChange);
            });
        }

        function handleFieldChange(event) {
            const field = event.target;
            const appId = field.getAttribute('data-app-id');
            const fieldName = field.getAttribute('data-field');
            
            if (!appId || !fieldName) return;

            // Clear existing timeout for this field
            if (saveTimeouts[appId + '_' + fieldName]) {
                clearTimeout(saveTimeouts[appId + '_' + fieldName]);
            }

            // Show saving indicator
            const indicator = field.parentElement.querySelector('.saving-indicator');
            if (!indicator) {
                const savingDiv = document.createElement('span');
                savingDiv.className = 'saving-indicator';
                savingDiv.textContent = 'Saving...';
                field.parentElement.appendChild(savingDiv);
            }

            // Debounce save (wait 1 second after user stops typing)
            saveTimeouts[appId + '_' + fieldName] = setTimeout(() => {
                saveField(appId, fieldName, field.value);
            }, 1000);
        }

        function saveField(appId, fieldName, value) {
            // Find the application in our array
            const app = applications.find(a => a.id == appId);
            if (!app) return;

            // Update local data
            app[fieldName] = value;

            // Update link cell if it's the link field
            if (fieldName === 'link_to_job_req') {
                const row = document.querySelector(`tr[data-app-id="${appId}"]`);
                if (row) {
                    const linkCell = row.querySelector('.link-cell');
                    if (linkCell) {
                        const linkDiv = linkCell.querySelector('div');
                        if (linkDiv) {
                            if (value && value.trim()) {
                                let link = linkDiv.querySelector('a');
                                if (!link) {
                                    link = document.createElement('a');
                                    link.target = '_blank';
                                    link.style.fontSize = '12px';
                                    link.textContent = 'Open Link →';
                                    linkDiv.appendChild(link);
                                }
                                link.href = value.trim();
                            } else {
                                const link = linkDiv.querySelector('a');
                                if (link) link.remove();
                            }
                        }
                    }
                }
            }

            // Save to server
            fetch(`/api/applications/${appId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(app)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showMessage('Error saving: ' + data.error, 'error');
                } else {
                    // Remove saving indicator
                    const indicator = document.querySelector(`tr[data-app-id="${appId}"] .saving-indicator`);
                    if (indicator) {
                        indicator.textContent = 'Saved';
                        setTimeout(() => indicator.remove(), 1000);
                    }
                }
            })
            .catch(error => {
                showMessage('Error saving: ' + error, 'error');
            });
        }

        function deleteApplication(appId) {
            if (!confirm('Are you sure you want to delete this application?')) {
                return;
            }

            // Get the application to find job_id before deleting
            const app = applications.find(a => a.id == appId);
            const jobId = app ? app.job_id : null;

            fetch(`/api/applications/${appId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showMessage('Error deleting: ' + data.error, 'error');
                } else {
                    applications = applications.filter(a => a.id != appId);
                    renderTable();
                    showMessage('Application deleted successfully', 'success');
                    
                    // Remove applied badge from jobs list if job_id exists
                    if (jobId || data.job_id) {
                        removeAppliedBadge(jobId || data.job_id);
                    }
                }
            })
            .catch(error => {
                showMessage('Error deleting: ' + error, 'error');
            });
        }

        function removeAppliedBadge(jobId) {
            // Use localStorage to signal badge removal
            // The jobs page will check this on load/visibility change
            if (jobId) {
                localStorage.setItem('removeAppliedBadge_' + jobId, Date.now().toString());
                
                // Try to notify parent/opener window if exists
                try {
                    if (window.opener) {
                        window.opener.postMessage({type: 'removeAppliedBadge', jobId: jobId}, '*');
                    }
                } catch(e) {}
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showMessage(message, type) {
            const statusDiv = document.getElementById('status-message');
            statusDiv.textContent = message;
            statusDiv.className = 'status-message ' + type;
            statusDiv.style.display = 'block';
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>

